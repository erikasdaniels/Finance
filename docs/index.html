<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Forecaster | Premium Analytics</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Forecaster">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --border: #334155;
            --success: #10b981;
            --font-family: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            width: 380px;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            flex-shrink: 0;
            padding: 1.5rem;
        }

        aside::-webkit-scrollbar {
            width: 6px;
        }

        aside::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .input-label {
            color: var(--text-primary);
        }

        .input-val {
            color: var(--accent);
            font-weight: 600;
        }

        input[type="number"] {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 6px;
            font-family: inherit;
        }

        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: var(--border);
            border-radius: 2px;
        }

        /* Main Content */
        main {
            flex-grow: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            flex-grow: 1;
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .kpi-card {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .kpi-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .kpi-sub {
            font-size: 0.8rem;
            color: var(--success);
            margin-top: 0.25rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .tab-content {
            display: none;
            flex-direction: column;
            gap: 1.5rem;
            height: 100%;
        }

        .tab-content.active {
            display: flex;
        }

        /* Receipt Card */
        .receipt-view {
            display: grid;
            grid-template-columns: 350px 550px;
            gap: 3rem;
            align-items: start;
            justify-content: center;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        .receipt-age-picker {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .error-message {
            color: #ef4444;
            font-size: 0.8rem;
            margin-top: 1rem;
            display: none;
            padding: 0.5rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .receipt-card {
            background: #fff;
            color: #1e293b;
            padding: 2rem;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            width: 550px;
            /* Increased to accommodate extra column */
        }

        .receipt-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: repeating-linear-gradient(90deg, #1e293b, #1e293b 10px, transparent 10px, transparent 20px);
        }

        .receipt-header {
            text-align: center;
            border-bottom: 1px dashed #cbd5e1;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .receipt-divider {
            border-bottom: 1px dashed #cbd5e1;
            margin: 1rem 0;
        }

        .receipt-total {
            font-weight: 700;
            font-size: 1.2rem;
            margin-top: 1rem;
        }

        .receipt-age-picker {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                overflow-y: auto;
                height: auto;
            }

            aside {
                width: 100%;
                height: auto;
                border: none;
                border-bottom: 1px solid var(--border);
            }

            main {
                height: auto;
            }

            .kpi-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-container {
                height: 500px;
            }

            .receipt-view {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .receipt-card {
                order: 2;
                width: 100%;
                min-width: 0;
                /* Allow it to shrink on mobile */
                padding: 1rem;
                font-size: 0.8rem;
            }

            .receipt-age-picker {
                order: 1;
            }
        }
    </style>
</head>

<body>

    <aside id="sidebar">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
            </svg>
            <span>PortfolioNet</span>
        </div>

        <!-- Controls generated by JS -->
    </aside>

    <main>
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('chart')">Analytics Chart</button>
            <button class="tab-btn" onclick="showTab('receipt')">Tax Receipt</button>
        </div>

        <div id="chart-tab" class="tab-content active">
            <div class="kpi-row">
                <div class="kpi-card">
                    <div class="kpi-label">Final Net Worth</div>
                    <div class="kpi-value" id="kpi-networth">-</div>
                    <div class="kpi-sub" id="kpi-age">Age: -</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Pension Pot</div>
                    <div class="kpi-value" id="kpi-pension">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Liquid Assets (ISA/Cash)</div>
                    <div class="kpi-value" id="kpi-liquid">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Property Equity</div>
                    <div class="kpi-value" id="kpi-equity">-</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>

        <div id="receipt-tab" class="tab-content">
            <div class="receipt-view">
                <div class="receipt-age-picker">
                    <div class="section-header" style="margin-top: 0;">Projection Age</div>
                    <div class="input-group">
                        <div class="input-header">
                            <span class="input-label">Select Age</span>
                            <span class="input-val" id="receipt-age-val">22</span>
                        </div>
                        <input type="range" id="receipt-age-slider" min="22" max="62" step="1" value="22">
                    </div>

                    <div class="section-header">Budget Splits (%)</div>
                    <div id="split-controls">
                        <!-- Split inputs injected here -->
                    </div>
                    <div id="split-error" class="error-message">
                        Total must add up to 100%!
                    </div>
                </div>

                <div class="receipt-card" id="tax-receipt">
                    <!-- Receipt content injected here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Configuration --
        const CONFIG = {
            inputs: [
                { header: "Core Assumptions" },
                { id: "base_salary", label: "Base Salary (£)", type: "number", value: 32000 },
                { id: "years", label: "Years to Simulate", type: "number", value: 40 },
                { id: "start_age", label: "Start Age", type: "range", min: 18, max: 60, step: 1, value: 22 },
                { id: "growth_rate", label: "Salary Growth", type: "range", min: 0, max: 20, step: 0.1, value: 6, isPercentage: true },
                { id: "inflation", label: "Inflation", type: "range", min: 0, max: 20, step: 0.1, value: 3, isPercentage: true },

                { header: "Retirement Goals" },
                { id: "retire_age", label: "Retirement Age", type: "range", min: 40, max: 75, step: 1, value: 60 },
                { id: "retire_income", label: "Retirement Income (£)", type: "number", value: 25000 },

                { header: "Starting Balances" },
                { id: "pension_base", label: "Pension Base (£)", type: "number", value: 2000 },
                { id: "isa_base", label: "ISA Base (£)", type: "number", value: 20000 },
                { id: "cash_base", label: "Cash Base (£)", type: "number", value: 11000 },
                { id: "lisa_base", label: "LISA Base (£)", type: "number", value: 0 },

                { header: "Investment Growth Rates" },
                { id: "pension_rate", label: "Pension Rate", type: "range", min: 0, max: 20, step: 0.1, value: 8, isPercentage: true },
                { id: "isa_rate", label: "ISA Rate", type: "range", min: 0, max: 20, step: 0.1, value: 11, isPercentage: true },
                { id: "cash_rate", label: "Cash Rate", type: "range", min: 0, max: 20, step: 0.1, value: 4.5, isPercentage: true },
                { id: "lisa_rate", label: "LISA Rate", type: "range", min: 0, max: 20, step: 0.1, value: 7, isPercentage: true },

                { header: "Contribution Rules" },
                { id: "pension_employee_rate", label: "Employee Pension %", type: "number", value: 5, step: 0.5, isPercentage: true },
                { id: "pension_employer_rate", label: "Employer Pension %", type: "number", value: 10, step: 0.5, isPercentage: true },
                { id: "isa_contribution_rate", label: "ISA Contribution Rate %", type: "number", value: 15, step: 0.5, isPercentage: true },
                { id: "lisa_max_contribution", label: "LISA Maximum Contribution (£)", type: "number", value: 4000 },
                { id: "lisa_bonus_rate", label: "LISA Bonus Rate %", type: "number", value: 25, isPercentage: true },

                { header: "Property Assumptions" },
                { id: "property_price_start", label: "Start Price (£)", type: "number", value: 170000 },
                { id: "deposit_rate", label: "Deposit Rate %", type: "number", value: 10, step: 1, isPercentage: true },
                { id: "house_price_growth", label: "House Price Growth", type: "range", min: 0, max: 20, step: 0.1, value: 5, isPercentage: true },
                { id: "mortgage_rate", label: "Mortgage Rate", type: "range", min: 0, max: 20, step: 0.1, value: 4.5, isPercentage: true },
                { id: "mortgage_term", label: "Mortgage Term", type: "number", value: 30 },
            ]
        };

        let chart = null;

        // --- Core Logic ---

        function getVal(id) {
            const el = document.getElementById(id);
            const raw = parseFloat(el.value) || 0;

            // Find config to check if percentage
            const def = CONFIG.inputs.find(d => d.id === id);
            if (def && def.isPercentage) {
                return raw / 100.0;
            }
            return raw;
        }

        // Tax logic and Simulation Loop remain largely identical, just consuming the getVal output

        function calculateNetPay(gross, pensionRate) {
            // ... (Logic unchanged)
            const personalAllowance = 12570;
            const basicLimit = 50270;
            const NI_lower = 12570;
            const NI_upper = 50270;

            const basicRate = 0.20;
            const NI_main_rate = 0.08;
            const NI_upper_rate = 0.02;

            const loanThreshold = 28470;
            const loanRate = 0.09;

            const pensionContrib = pensionRate * gross;
            const taxable = Math.max(0, gross - pensionContrib);

            // Income Tax
            let tax = 0;
            if (taxable > personalAllowance) {
                const taxableIncome = taxable - personalAllowance;
                const basicBandWidth = basicLimit - personalAllowance;

                if (taxableIncome <= basicBandWidth) {
                    tax = taxableIncome * basicRate;
                } else {
                    tax = (basicBandWidth * basicRate) + ((taxableIncome - basicBandWidth) * 0.40);
                }
            }

            // NI
            let ni = 0;
            if (taxable > NI_lower) {
                if (taxable <= NI_upper) {
                    ni = (taxable - NI_lower) * NI_main_rate;
                } else {
                    ni = ((NI_upper - NI_lower) * NI_main_rate) + ((taxable - NI_upper) * NI_upper_rate);
                }
            }

            // Student Loan
            const loan = Math.max(0, (taxable - loanThreshold) * loanRate);

            return gross - pensionContrib - tax - ni - loan;
        }

        function runSimulation() {
            // Retrieve inputs (getVal handles /100 conversion)
            const base_salary = getVal('base_salary');
            const years = getVal('years');
            const start_age = getVal('start_age');
            const growth_rate = getVal('growth_rate');
            const inflation = getVal('inflation');

            const retire_age = getVal('retire_age');
            const retire_income = getVal('retire_income');

            const pension_base = getVal('pension_base');
            const isa_base = getVal('isa_base');
            const cash_base = getVal('cash_base');
            const lisa_base = getVal('lisa_base');

            const pension_rate = getVal('pension_rate');
            const isa_rate = getVal('isa_rate');
            const cash_rate = getVal('cash_rate');
            const lisa_rate = getVal('lisa_rate');

            const pension_employee_rate = getVal('pension_employee_rate');
            const pension_employer_rate = getVal('pension_employer_rate');
            const isa_contribution_rate = getVal('isa_contribution_rate');
            const lisa_max_contribution = getVal('lisa_max_contribution');
            const lisa_bonus_rate = getVal('lisa_bonus_rate');

            const property_price_start = getVal('property_price_start');
            const deposit_rate = getVal('deposit_rate');
            const house_price_growth = getVal('house_price_growth');
            const mortgage_rate = getVal('mortgage_rate');
            const mortgage_term = getVal('mortgage_term');

            const mortgage_rate_real = (1 + mortgage_rate) / (1 + inflation) - 1;

            // Constants
            const state_pension_age = 67;
            const state_pension_amount = 12000;
            const pension_access_age = 57;
            const lisa_access_age = 60;

            // Arrays
            let nominal_salary = [base_salary];
            let real_salary = [base_salary];
            let net_salary = [calculateNetPay(base_salary, pension_employee_rate)];

            let pension = [pension_base];
            let isa = [isa_base];
            let cash = [cash_base];
            let lisa = [lisa_base];

            let property_value = [0];
            let mortgage_balance = [0];
            let home_equity = [0];

            let house_bought = false;
            let annual_mortgage_payment = 0;

            let ages = [];

            // Loop
            for (let year = 0; year < years; year++) {
                ages.push(start_age + year);
                if (year === 0) continue; // Initial setup already done

                const current_age = start_age + year;
                const is_retired = current_age >= retire_age;
                const prev_idx = year - 1;

                // Growth
                const pen_growth = pension[prev_idx] * (1 + pension_rate - inflation);
                const isa_growth = isa[prev_idx] * (1 + isa_rate - inflation);
                const cash_growth = cash[prev_idx] * (1 + cash_rate - inflation);
                const lisa_growth = lisa[prev_idx] * (1 + lisa_rate - inflation);

                let pen_contrib = 0;
                let isa_contrib = 0;
                let lisa_contrib = 0;
                let lisa_bonus = 0;

                if (!is_retired) {
                    // Working
                    nominal_salary.push(nominal_salary[prev_idx] * (1 + growth_rate));
                    real_salary.push(real_salary[prev_idx] * (1 + growth_rate - inflation));

                    const current_net = calculateNetPay(real_salary[year], pension_employee_rate);
                    net_salary.push(current_net);

                    pen_contrib = (pension_employee_rate + pension_employer_rate) * real_salary[year];
                    isa_contrib = isa_contribution_rate * current_net;

                    if (!house_bought) {
                        lisa_contrib = Math.min(lisa_max_contribution, 0.2 * current_net);
                        lisa_bonus = lisa_contrib * lisa_bonus_rate;
                    }
                } else {
                    nominal_salary.push(0);
                    real_salary.push(0);
                    net_salary.push(0);
                }

                // Drawdown Logic
                let pen_withdraw = 0;
                let isa_withdraw = 0;
                let cash_withdraw = 0;
                let lisa_withdraw = 0;

                if (is_retired) {
                    let required = retire_income;
                    if (current_age >= state_pension_age) {
                        required = Math.max(0, required - state_pension_amount);
                    }

                    let remaining = required;

                    // 1. Locked Phase (< 57) -> ISA/Cash
                    if (current_age < pension_access_age) {
                        const take_isa = Math.min(remaining, isa_growth);
                        isa_withdraw += take_isa;
                        remaining -= take_isa;

                        if (remaining > 0) {
                            const take_cash = Math.min(remaining, cash_growth);
                            cash_withdraw += take_cash;
                            remaining -= take_cash;
                        }
                    } else {
                        // 2. Accessible -> Pension first
                        const take_pen = Math.min(remaining, pen_growth);
                        pen_withdraw += take_pen;
                        remaining -= take_pen;

                        // 3. LISA if >= 60
                        if (remaining > 0 && current_age >= lisa_access_age) {
                            const take_lisa = Math.min(remaining, lisa_growth);
                            lisa_withdraw += take_lisa;
                            remaining -= take_lisa;
                        }

                        // 4. Fallback ISA
                        if (remaining > 0) {
                            const take_isa = Math.min(remaining, isa_growth);
                            isa_withdraw += take_isa;
                            remaining -= take_isa;
                        }

                        // 5. Fallback Cash
                        if (remaining > 0) {
                            const take_cash = Math.min(remaining, cash_growth);
                            cash_withdraw += take_cash;
                            remaining -= take_cash;
                        }
                    }
                }

                // Apply Updates
                pension.push(Math.max(0, pen_growth + pen_contrib - pen_withdraw));
                isa.push(Math.max(0, isa_growth + isa_contrib - isa_withdraw));
                cash.push(Math.max(0, cash_growth - cash_withdraw));

                let new_lisa = lisa_growth + lisa_contrib + lisa_bonus - lisa_withdraw;

                // Property Logic
                const current_house_price = property_price_start * Math.pow(1 + house_price_growth - inflation, year);
                const deposit_required = current_house_price * deposit_rate;

                if (!house_bought && new_lisa >= deposit_required) {
                    house_bought = true;
                    property_value.push(current_house_price);

                    const initial_mortgage = current_house_price - deposit_required;
                    mortgage_balance.push(initial_mortgage);
                    home_equity.push(deposit_required);

                    new_lisa -= deposit_required;
                    annual_mortgage_payment = initial_mortgage / mortgage_term;
                } else if (house_bought) {
                    property_value.push(property_value[prev_idx] * (1 + house_price_growth - inflation));

                    const bal = mortgage_balance[prev_idx] * (1 + mortgage_rate_real) - annual_mortgage_payment;
                    mortgage_balance.push(Math.max(0, bal));

                    home_equity.push(property_value[year] - mortgage_balance[year]);
                } else {
                    property_value.push(0);
                    mortgage_balance.push(0);
                    home_equity.push(0);
                }

                lisa.push(Math.max(0, new_lisa));
            }

            // Net Worth
            const net_worth = pension.map((p, i) => p + isa[i] + cash[i] + lisa[i] + home_equity[i]);

            return { ages, pension, isa, lisa, cash, home_equity, net_worth, real_salary, nominal_salary };
        }

        function initUI() {
            const sidebar = document.getElementById('sidebar');

            CONFIG.inputs.forEach(def => {
                if (def.header) {
                    const h = document.createElement('div');
                    h.className = 'section-header';
                    h.innerText = def.header;
                    sidebar.appendChild(h);
                    return;
                }

                const group = document.createElement('div');
                group.className = 'input-group';

                const header = document.createElement('div');
                header.className = 'input-header';

                const label = document.createElement('span');
                label.className = 'input-label';
                label.innerText = def.label;

                const displayVal = document.createElement('span');
                displayVal.className = 'input-val';
                displayVal.id = 'disp_' + def.id;
                displayVal.innerText = formatValue(def.value, def);

                header.appendChild(label);
                header.appendChild(displayVal);
                group.appendChild(header);

                const input = document.createElement('input');
                input.id = def.id;
                input.type = def.type;
                input.value = def.value;

                if (def.type === 'range') {
                    input.min = def.min;
                    input.max = def.max;
                    input.step = def.step || 0.1;
                } else {
                    // For number inputs, set step to 0.1 if percentage
                    if (def.isPercentage) input.step = 0.5;
                    else if (def.step) input.step = def.step;
                }

                input.addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    document.getElementById('disp_' + def.id).innerText = formatValue(val, def);
                    updateChart();
                });

                group.appendChild(input);
                sidebar.appendChild(group);
            });
        }

        function formatValue(val, def) {
            if (def.isPercentage) return val.toFixed(1) + '%';
            if (typeof val === 'number' && val >= 1000) return (val / 1000).toFixed(1) + 'k';
            return val;
        }

        function updateChart() {
            const data = runSimulation();
            updateKPIs(data);

            // Chart Data
            const chartData = {
                labels: data.ages,
                datasets: [
                    {
                        label: 'Total Net Worth',
                        data: data.net_worth,
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0
                    },
                    {
                        label: 'Pension',
                        data: data.pension,
                        borderColor: '#3b82f6', // Blue
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    },
                    {
                        label: 'ISA',
                        data: data.isa,
                        borderColor: '#10b981', // Green
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    },
                    {
                        label: 'LISA',
                        data: data.lisa,
                        borderColor: '#f59e0b', // Amber
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    },
                    {
                        label: 'Cash',
                        data: data.cash,
                        borderColor: '#64748b', // Slate
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    },
                    {
                        label: 'Equity',
                        data: data.home_equity,
                        borderColor: '#8b5cf6', // Purple
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0
                    }
                ]
            };

            if (chart) {
                chart.data = chartData;
                chart.update();
            } else {
                const ctx = document.getElementById('portfolioChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { position: 'top', labels: { color: '#94a3b8' } },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleColor: '#f8fafc',
                                bodyColor: '#cbd5e1',
                                borderColor: '#334155',
                                borderWidth: 1,
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumSignificantDigits: 3 }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#334155', tickColor: '#334155' },
                                ticks: { color: '#94a3b8' }
                            },
                            y: {
                                grid: { color: '#334155', tickColor: '#334155' },
                                ticks: {
                                    color: '#94a3b8',
                                    callback: function (value) {
                                        if (value >= 1000000) return '£' + (value / 1000000).toFixed(1) + 'm';
                                        if (value >= 1000) return '£' + (value / 1000).toFixed(0) + 'k';
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateKPIs(data) {
            const last = data.ages.length - 1;

            const fmt = (v) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(v);

            document.getElementById('kpi-networth').innerText = fmt(data.net_worth[last]);
            document.getElementById('kpi-pension').innerText = fmt(data.pension[last]);
            document.getElementById('kpi-liquid').innerText = fmt(data.isa[last] + data.cash[last] + data.lisa[last]);
            document.getElementById('kpi-equity').innerText = fmt(data.home_equity[last]);
            document.getElementById('kpi-age').innerText = `At Age ${data.ages[last]}`;
        }

        // --- New Logic for Tax Receipt ---

        let budgetSplits = {
            needs: 60,
            isa: 15,
            savings: 5,
            wants: 20
        };

        function updateBudgetSplitsFromSettings() {
            // Automatically sync ISA contribution from core settings if user hasn't manually overridden or for initial load
            const coreIsaRate = getVal('isa_contribution_rate') * 100; // Use isa_contribution_rate from CONFIG
            budgetSplits.isa = Math.round(coreIsaRate);

            // Adjust others proportionally to keep 100%
            const remaining = 100 - budgetSplits.isa;
            const currentNonIsaTotal = budgetSplits.needs + budgetSplits.savings + budgetSplits.wants;

            if (currentNonIsaTotal > 0) {
                budgetSplits.needs = Math.round((budgetSplits.needs / currentNonIsaTotal) * remaining);
                budgetSplits.savings = Math.round((budgetSplits.savings / currentNonIsaTotal) * remaining);
                budgetSplits.wants = 100 - budgetSplits.isa - budgetSplits.needs - budgetSplits.savings;
            }

            // Refresh inputs
            const container = document.getElementById('split-controls');
            if (container) {
                container.innerHTML = '';
                initSplitControls();
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabId + '-tab').classList.add('active');

            if (tabId === 'receipt') renderReceipt();
        }

        function initSplitControls() {
            const container = document.getElementById('split-controls');
            const keys = Object.keys(budgetSplits);

            keys.forEach(key => {
                const group = document.createElement('div');
                group.className = 'input-group';
                group.style.display = 'flex';
                group.style.alignItems = 'center';
                group.style.justifyContent = 'space-between';
                group.style.marginBottom = '0.5rem';

                const label = document.createElement('span');
                label.className = 'input-label';
                label.innerText = key === 'isa' ? 'ISA' : key.charAt(0).toUpperCase() + key.slice(1);

                const input = document.createElement('input');
                input.type = 'number';
                input.min = 0;
                input.max = 100;
                input.value = budgetSplits[key];
                input.style.width = '70px';
                input.style.textAlign = 'right';
                input.addEventListener('input', (e) => updateSplits(key, parseInt(e.target.value) || 0));

                group.appendChild(label);
                group.appendChild(input);
                container.appendChild(group);
            });
        }

        function updateSplits(changedKey, newValue) {
            budgetSplits[changedKey] = newValue;

            const total = Object.values(budgetSplits).reduce((a, b) => a + b, 0);
            const errorEl = document.getElementById('split-error');

            if (total !== 100) {
                errorEl.style.display = 'block';
                errorEl.innerText = `Total is ${total}% (Must be 100%)`;
            } else {
                errorEl.style.display = 'none';
                renderReceipt();
            }
        }

        function calculateDetailedTaxes(gross, pensionRate, employerPensionRate) {
            const personalAllowance = 12570;
            const basicLimit = 50270;
            const NI_lower = 12570;
            const NI_upper = 50270;

            const basicRate = 0.20;
            const NI_main_rate = 0.08;
            const NI_upper_rate = 0.02;

            const loanThreshold = 28470;
            const loanRate = 0.09;

            const pensionContribution = pensionRate * gross;
            const taxable = Math.max(0, gross - pensionContribution);

            let tax = 0;
            if (taxable > personalAllowance) {
                const taxableIncome = taxable - personalAllowance;
                const basicBandWidth = basicLimit - personalAllowance;
                if (taxableIncome <= basicBandWidth) tax = taxableIncome * basicRate;
                else tax = (basicBandWidth * basicRate) + ((taxableIncome - basicBandWidth) * 0.40);
            }

            let ni = 0;
            if (taxable > NI_lower) {
                if (taxable <= NI_upper) ni = (taxable - NI_lower) * NI_main_rate;
                else ni = ((NI_upper - NI_lower) * NI_main_rate) + ((taxable - NI_upper) * NI_upper_rate);
            }

            const loan = Math.max(0, (taxable - loanThreshold) * loanRate);
            const net = gross - pensionContribution - tax - ni - loan;

            return {
                net,
                pensionContribution,
                tax,
                ni,
                loan,
                employerPension: employerPensionRate * gross
            };
        }

        function renderReceipt() {
            const age = parseInt(document.getElementById('receipt-age-slider').value);
            document.getElementById('receipt-age-val').innerText = age;

            const total = Object.values(budgetSplits).reduce((a, b) => a + b, 0);
            if (total !== 100) return; // Don't update if data is invalid

            const data = runSimulation();
            const startAge = getVal('start_age');
            const index = age - startAge;

            const realSalary = data.real_salary[index];
            const pensionEmployeeRate = getVal('pension_employee_rate');
            const pensionEmployerRate = getVal('pension_employer_rate');

            const details = calculateDetailedTaxes(realSalary, pensionEmployeeRate, pensionEmployerRate);
            const fmt = (v) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);

            const container = document.getElementById('tax-receipt');
            container.innerHTML = `
                <div class="receipt-header">
                    <h2 style="margin-bottom: 0.5rem;">TAX & PAY RECEIPT</h2>
                    <p style="font-size: 0.8rem; color: #64748b;">PROJECTED FOR AGE ${age}</p>
                </div>

                <div class="receipt-row" style="font-weight: bold; font-size: 0.75rem; color: #64748b;">
                    <span style="flex: 2;">DESCRIPTION</span>
                    <span style="flex: 1; text-align: right;">MONTHLY</span>
                    <span style="flex: 1; text-align: right;">YEARLY</span>
                </div>
                <div class="receipt-divider"></div>

                <div class="receipt-row"><span style="flex: 2;">Gross Salary</span> <span style="flex: 1; text-align: right;">${fmt(realSalary / 12)}</span> <span style="flex: 1; text-align: right;">${fmt(realSalary)}</span></div>
                
                <div class="receipt-divider"></div>
                <p style="font-size: 0.75rem; margin-bottom: 0.5rem; font-weight: bold;">DEDUCTIONS (EMPLOYEE)</p>
                <div class="receipt-row"><span style="flex: 2;">Pension (${(pensionEmployeeRate * 100).toFixed(0)}%)</span> <span style="flex: 1; text-align: right;">-${fmt(details.pensionContribution / 12)}</span> <span style="flex: 1; text-align: right;">-${fmt(details.pensionContribution)}</span></div>
                <div class="receipt-row"><span style="flex: 2;">Income Tax</span> <span style="flex: 1; text-align: right;">-${fmt(details.tax / 12)}</span> <span style="flex: 1; text-align: right;">-${fmt(details.tax)}</span></div>
                <div class="receipt-row"><span style="flex: 2;">National Insurance</span> <span style="flex: 1; text-align: right;">-${fmt(details.ni / 12)}</span> <span style="flex: 1; text-align: right;">-${fmt(details.ni)}</span></div>
                <div class="receipt-row"><span style="flex: 2;">Student Loan</span> <span style="flex: 1; text-align: right;">-${fmt(details.loan / 12)}</span> <span style="flex: 1; text-align: right;">-${fmt(details.loan)}</span></div>

                <div class="receipt-divider"></div>
                <p style="font-size: 0.75rem; margin-bottom: 0.5rem; font-weight: bold;">EMPLOYER CONTRIBUTIONS</p>
                <div class="receipt-row"><span style="flex: 2;">Employer Pension (${(pensionEmployerRate * 100).toFixed(0)}%)</span> <span style="flex: 1; text-align: right;">${fmt(details.employerPension / 12)}</span> <span style="flex: 1; text-align: right;">${fmt(details.employerPension)}</span></div>

                <div class="receipt-divider"></div>
                <div class="receipt-row receipt-total" style="font-size: 1rem;">
                    <span style="flex: 2;">NET TAKE-HOME</span> 
                    <span style="flex: 1; text-align: right;">${fmt(details.net / 12)}</span> 
                    <span style="flex: 1; text-align: right;">${fmt(details.net)}</span>
                </div>

                <div class="receipt-divider"></div>
                <p style="font-size: 0.75rem; margin-bottom: 0.5rem; font-weight: bold;">BUDGET ALLOCATION</p>
                <div class="receipt-row"><span style="flex: 2;">Needs (${budgetSplits.needs}%)</span> <span style="flex: 1; text-align: right;">${fmt(details.net * budgetSplits.needs / 100 / 12)}</span> <span style="flex: 1; text-align: right;">${fmt(details.net * budgetSplits.needs / 100)}</span></div>
                <div class="receipt-row"><span style="flex: 2;">ISA (${budgetSplits.isa}%)</span> <span style="flex: 1; text-align: right;">${fmt(details.net * budgetSplits.isa / 100 / 12)}</span> <span style="flex: 1; text-align: right;">${fmt(details.net * budgetSplits.isa / 100)}</span></div>
                <div class="receipt-row"><span style="flex: 2;">Savings (${budgetSplits.savings}%)</span> <span style="flex: 1; text-align: right;">${fmt(details.net * budgetSplits.savings / 100 / 12)}</span> <span style="flex: 1; text-align: right;">${fmt(details.net * budgetSplits.savings / 100)}</span></div>
                <div class="receipt-row"><span style="flex: 2;">Wants (${budgetSplits.wants}%)</span> <span style="flex: 1; text-align: right;">${fmt(details.net * budgetSplits.wants / 100 / 12)}</span> <span style="flex: 1; text-align: right;">${fmt(details.net * budgetSplits.wants / 100)}</span></div>
                
                <div class="receipt-divider" style="margin-top: 2rem;"></div>
                <p style="text-align: center; font-size: 0.7rem;">THANK YOU FOR PLANNING YOUR FUTURE</p>
            `;
        }

        // --- Init ---
        initUI();
        initSplitControls();
        updateChart();

        // Sync age slider range with simulation range
        function syncAgeSlider() {
            const slider = document.getElementById('receipt-age-slider');
            const start = getVal('start_age');
            const years = getVal('years');
            slider.min = start;
            slider.max = start + years - 1;
            if (slider.value < start) slider.value = start;
            if (slider.value > slider.max) slider.value = slider.max;
        }

        document.getElementById('receipt-age-slider').addEventListener('input', renderReceipt);

        // Update range whenever core inputs change
        const coreInputs = ['start_age', 'years', 'isa_contribution_rate'];
        coreInputs.forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                syncAgeSlider();
                if (id === 'isa_contribution_rate') updateBudgetSplitsFromSettings();
                renderReceipt();
            });
        });

        syncAgeSlider();
        updateBudgetSplitsFromSettings();
        renderReceipt();

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed', err));
            });
        }

    </script>
</body>

</html>