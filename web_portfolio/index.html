<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Forecaster | Premium Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --border: #334155;
            --success: #10b981;
            --font-family: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            width: 380px;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            flex-shrink: 0;
            padding: 1.5rem;
        }

        aside::-webkit-scrollbar {
            width: 6px;
        }
        aside::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-header {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .input-label {
            color: var(--text-primary);
        }

        .input-val {
            color: var(--accent);
            font-weight: 600;
        }

        input[type="number"] {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 6px;
            font-family: inherit;
        }

        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: var(--border);
            border-radius: 2px;
        }

        /* Main Content */
        main {
            flex-grow: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow: hidden;
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            flex-grow: 1;
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .kpi-card {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .kpi-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .kpi-sub {
            font-size: 0.8rem;
            color: var(--success);
            margin-top: 0.25rem;
        }

        @media (max-width: 1024px) {
            body { flex-direction: column; overflow-y: auto; height: auto;}
            aside { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border); }
            main { height: auto; }
            .chart-container { height: 500px; }
            .kpi-row { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<aside id="sidebar">
    <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
        <span>PortfolioNet</span>
    </div>
    
    <!-- Controls generated by JS -->
</aside>

<main>
    <div class="kpi-row">
        <div class="kpi-card">
            <div class="kpi-label">Final Net Worth</div>
            <div class="kpi-value" id="kpi-networth">-</div>
            <div class="kpi-sub" id="kpi-age">Age: -</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Pension Pot</div>
            <div class="kpi-value" id="kpi-pension">-</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Liquid Assets (ISA/Cash)</div>
            <div class="kpi-value" id="kpi-liquid">-</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Property Equity</div>
            <div class="kpi-value" id="kpi-equity">-</div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="portfolioChart"></canvas>
    </div>
</main>

<script>
    // --- Configuration --
    const CONFIG = {
        inputs: [
            { header: "Core Assumptions" },
            { id: "base_salary", label: "Base Salary (£)", type: "number", value: 32000 },
            { id: "years", label: "Years to Simulate", type: "number", value: 40 },
            { id: "start_age", label: "Start Age", type: "range", min: 18, max: 60, step: 1, value: 22 },
            { id: "growth_rate", label: "Salary Growth", type: "range", min: 0, max: 0.2, step: 0.001, value: 0.06, format: "%" },
            { id: "inflation", label: "Inflation", type: "range", min: 0, max: 0.2, step: 0.001, value: 0.03, format: "%" },

            { header: "Retirement Goals" },
            { id: "retire_age", label: "Retirement Age", type: "range", min: 40, max: 75, step: 1, value: 60 },
            { id: "retire_income", label: "Retirement Income (£)", type: "number", value: 25000 },

            { header: "Starting Balances" },
            { id: "pension_base", label: "Pension Base (£)", type: "number", value: 2000 },
            { id: "isa_base", label: "ISA Base (£)", type: "number", value: 20000 },
            { id: "cash_base", label: "Cash Base (£)", type: "number", value: 11000 },
            { id: "lisa_base", label: "LISA Base (£)", type: "number", value: 0 },

            { header: "Investment Growth Rates" },
            { id: "pension_rate", label: "Pension Rate", type: "range", min: 0, max: 0.2, step: 0.001, value: 0.08, format: "%" },
            { id: "isa_rate", label: "ISA Rate", type: "range", min: 0, max: 0.2, step: 0.001, value: 0.11, format: "%" },
            { id: "cash_rate", label: "Cash Rate", type: "range", min: 0, max: 0.2, step: 0.001, value: 0.045, format: "%" },
            { id: "lisa_rate", label: "LISA Rate", type: "range", min: 0, max: 0.2, step: 0.001, value: 0.07, format: "%" },

            { header: "Contribution Rules" },
            { id: "pension_employee_rate", label: "Employee Pension %", type: "number", value: 0.05, step: 0.01 },
            { id: "pension_employer_rate", label: "Employer Pension %", type: "number", value: 0.10, step: 0.01 },
            { id: "isa_contribution_rate", label: "ISA Contrib Rate", type: "number", value: 0.15, step: 0.01 },
            { id: "lisa_max_contribution", label: "LISA Max Contrib (£)", type: "number", value: 4000 },
            { id: "lisa_bonus_rate", label: "LISA Bonus Rate", type: "number", value: 0.25 },

            { header: "Property Assumptions" },
            { id: "property_price_start", label: "Start Price (£)", type: "number", value: 170000 },
            { id: "deposit_rate", label: "Deposit Rate", type: "number", value: 0.10, step: 0.01 },
            { id: "house_price_growth", label: "House Price Growth", type: "range", min: 0, max: 0.2, step: 0.001, value: 0.05, format: "%" },
            { id: "mortgage_rate", label: "Mortgage Rate", type: "range", min: 0, max: 0.2, step: 0.001, value: 0.045, format: "%" },
            { id: "mortgage_term", label: "Mortgage Term", type: "number", value: 30 },
        ]
    };

    let chart = null;

    // --- Core Logic ---

    function getVal(id) {
        const el = document.getElementById(id);
        return parseFloat(el.value) || 0;
    }

    function calculateNetPay(gross, pensionRate) {
        const personalAllowance = 12570;
        const basicLimit = 50270;
        const NI_lower = 12570;
        const NI_upper = 50270;

        const basicRate = 0.20;
        const NI_main_rate = 0.08;
        const NI_upper_rate = 0.02;

        const loanThreshold = 28470;
        const loanRate = 0.09;

        const pensionContrib = pensionRate * gross;
        const taxable = Math.max(0, gross - pensionContrib);

        // Income Tax
        let tax = 0;
        if (taxable > personalAllowance) {
            const taxableIncome = taxable - personalAllowance;
            const basicBandWidth = basicLimit - personalAllowance;
            
            if (taxableIncome <= basicBandWidth) {
                tax = taxableIncome * basicRate;
            } else {
                tax = (basicBandWidth * basicRate) + ((taxableIncome - basicBandWidth) * 0.40);
            }
        }

        // NI
        let ni = 0;
        if (taxable > NI_lower) {
            if (taxable <= NI_upper) {
                ni = (taxable - NI_lower) * NI_main_rate;
            } else {
                ni = ((NI_upper - NI_lower) * NI_main_rate) + ((taxable - NI_upper) * NI_upper_rate);
            }
        }

        // Student Loan
        const loan = Math.max(0, (taxable - loanThreshold) * loanRate);

        return gross - pensionContrib - tax - ni - loan;
    }

    function runSimulation() {
        // Retrieve inputs
        const base_salary = getVal('base_salary');
        const years = getVal('years');
        const start_age = getVal('start_age');
        const growth_rate = getVal('growth_rate');
        const inflation = getVal('inflation');

        const retire_age = getVal('retire_age');
        const retire_income = getVal('retire_income');

        const pension_base = getVal('pension_base');
        const isa_base = getVal('isa_base');
        const cash_base = getVal('cash_base');
        const lisa_base = getVal('lisa_base');

        const pension_rate = getVal('pension_rate');
        const isa_rate = getVal('isa_rate');
        const cash_rate = getVal('cash_rate');
        const lisa_rate = getVal('lisa_rate');

        const pension_employee_rate = getVal('pension_employee_rate');
        const pension_employer_rate = getVal('pension_employer_rate');
        const isa_contribution_rate = getVal('isa_contribution_rate');
        const lisa_max_contribution = getVal('lisa_max_contribution');
        const lisa_bonus_rate = getVal('lisa_bonus_rate');

        const property_price_start = getVal('property_price_start');
        const deposit_rate = getVal('deposit_rate');
        const house_price_growth = getVal('house_price_growth');
        const mortgage_rate = getVal('mortgage_rate');
        const mortgage_term = getVal('mortgage_term');

        const mortgage_rate_real = (1 + mortgage_rate) / (1 + inflation) - 1;

        // Constants
        const state_pension_age = 67;
        const state_pension_amount = 12000;
        const pension_access_age = 57;
        const lisa_access_age = 60;

        // Arrays
        let nominal_salary = [base_salary];
        let real_salary = [base_salary];
        let net_salary = [calculateNetPay(base_salary, pension_employee_rate)];
        
        let pension = [pension_base];
        let isa = [isa_base];
        let cash = [cash_base];
        let lisa = [lisa_base];
        
        let property_value = [0];
        let mortgage_balance = [0];
        let home_equity = [0];

        let house_bought = false;
        let annual_mortgage_payment = 0;
        
        let ages = [];

        // Loop
        for (let year = 0; year < years; year++) {
            ages.push(start_age + year);
            if (year === 0) continue; // Initial setup already done

            const current_age = start_age + year;
            const is_retired = current_age >= retire_age;
            const prev_idx = year - 1;

            // Growth
            const pen_growth = pension[prev_idx] * (1 + pension_rate - inflation);
            const isa_growth = isa[prev_idx] * (1 + isa_rate - inflation);
            const cash_growth = cash[prev_idx] * (1 + cash_rate - inflation);
            const lisa_growth = lisa[prev_idx] * (1 + lisa_rate - inflation);

            let pen_contrib = 0;
            let isa_contrib = 0;
            let lisa_contrib = 0;
            let lisa_bonus = 0;

            if (!is_retired) {
                // Working
                nominal_salary.push(nominal_salary[prev_idx] * (1 + growth_rate));
                real_salary.push(real_salary[prev_idx] * (1 + growth_rate - inflation));
                
                const current_net = calculateNetPay(real_salary[year], pension_employee_rate);
                net_salary.push(current_net);

                pen_contrib = (pension_employee_rate + pension_employer_rate) * real_salary[year];
                isa_contrib = isa_contribution_rate * current_net;

                if (!house_bought) {
                    lisa_contrib = Math.min(lisa_max_contribution, 0.2 * current_net);
                    lisa_bonus = lisa_contrib * lisa_bonus_rate;
                }
            } else {
                nominal_salary.push(0);
                real_salary.push(0);
                net_salary.push(0);
            }

            // Drawdown Logic
            let pen_withdraw = 0;
            let isa_withdraw = 0;
            let cash_withdraw = 0;
            let lisa_withdraw = 0;

            if (is_retired) {
                let required = retire_income;
                if (current_age >= state_pension_age) {
                    required = Math.max(0, required - state_pension_amount);
                }

                let remaining = required;

                // 1. Locked Phase (< 57) -> ISA/Cash
                if (current_age < pension_access_age) {
                    const take_isa = Math.min(remaining, isa_growth);
                    isa_withdraw += take_isa;
                    remaining -= take_isa;

                    if (remaining > 0) {
                        const take_cash = Math.min(remaining, cash_growth);
                        cash_withdraw += take_cash;
                        remaining -= take_cash;
                    }
                } else {
                    // 2. Accessible -> Pension first
                    const take_pen = Math.min(remaining, pen_growth);
                    pen_withdraw += take_pen;
                    remaining -= take_pen;

                    // 3. LISA if >= 60
                    if (remaining > 0 && current_age >= lisa_access_age) {
                         const take_lisa = Math.min(remaining, lisa_growth);
                         lisa_withdraw += take_lisa;
                         remaining -= take_lisa;
                    }

                    // 4. Fallback ISA
                    if (remaining > 0) {
                         const take_isa = Math.min(remaining, isa_growth);
                         isa_withdraw += take_isa;
                         remaining -= take_isa;
                    }

                    // 5. Fallback Cash
                    if (remaining > 0) {
                         const take_cash = Math.min(remaining, cash_growth);
                         cash_withdraw += take_cash;
                         remaining -= take_cash;
                    }
                }
            }

            // Apply Updates
            pension.push(Math.max(0, pen_growth + pen_contrib - pen_withdraw));
            isa.push(Math.max(0, isa_growth + isa_contrib - isa_withdraw));
            cash.push(Math.max(0, cash_growth - cash_withdraw));
            
            let new_lisa = lisa_growth + lisa_contrib + lisa_bonus - lisa_withdraw;
            
            // Property Logic
            const current_house_price = property_price_start * Math.pow(1 + house_price_growth - inflation, year);
            const deposit_required = current_house_price * deposit_rate;

            if (!house_bought && new_lisa >= deposit_required) {
                house_bought = true;
                property_value.push(current_house_price);
                
                const initial_mortgage = current_house_price - deposit_required;
                mortgage_balance.push(initial_mortgage);
                home_equity.push(deposit_required);

                new_lisa -= deposit_required;
                annual_mortgage_payment = initial_mortgage / mortgage_term;
            } else if (house_bought) {
                property_value.push(property_value[prev_idx] * (1 + house_price_growth - inflation));
                
                const bal = mortgage_balance[prev_idx] * (1 + mortgage_rate_real) - annual_mortgage_payment;
                mortgage_balance.push(Math.max(0, bal));
                
                home_equity.push(property_value[year] - mortgage_balance[year]);
            } else {
                property_value.push(0);
                mortgage_balance.push(0);
                home_equity.push(0);
            }
            
            lisa.push(Math.max(0, new_lisa));
        }

        // Net Worth
        const net_worth = pension.map((p, i) => p + isa[i] + cash[i] + lisa[i] + home_equity[i]);

        return { ages, pension, isa, lisa, cash, home_equity, net_worth };
    }

    function initUI() {
        const sidebar = document.getElementById('sidebar');
        
        CONFIG.inputs.forEach(def => {
            if (def.header) {
                const h = document.createElement('div');
                h.className = 'section-header';
                h.innerText = def.header;
                sidebar.appendChild(h);
                return;
            }

            const group = document.createElement('div');
            group.className = 'input-group';

            const header = document.createElement('div');
            header.className = 'input-header';
            
            const label = document.createElement('span');
            label.className = 'input-label';
            label.innerText = def.label;
            
            const displayVal = document.createElement('span');
            displayVal.className = 'input-val';
            displayVal.id = 'disp_' + def.id;
            displayVal.innerText = formatValue(def.value, def);

            header.appendChild(label);
            header.appendChild(displayVal);
            group.appendChild(header);

            const input = document.createElement('input');
            input.id = def.id;
            input.type = def.type;
            input.value = def.value;
            
            if (def.type === 'range') {
                input.min = def.min;
                input.max = def.max;
                input.step = def.step || 0.001;
            } else {
                 if (def.step) input.step = def.step;
            }

            input.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                document.getElementById('disp_' + def.id).innerText = formatValue(val, def);
                updateChart();
            });

            group.appendChild(input);
            sidebar.appendChild(group);
        });
    }

    function formatValue(val, def) {
        if (def.format === '%') return (val * 100).toFixed(1) + '%';
        if (typeof val === 'number' && val >= 1000) return (val/1000).toFixed(1) + 'k';
        return val;
    }

    function updateChart() {
        const data = runSimulation();
        updateKPIs(data);

        // Chart Data
        const chartData = {
            labels: data.ages,
            datasets: [
                {
                    label: 'Total Net Worth',
                    data: data.net_worth,
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0
                },
                {
                    label: 'Pension',
                    data: data.pension,
                    borderColor: '#3b82f6', // Blue
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0
                },
                {
                    label: 'ISA',
                    data: data.isa,
                    borderColor: '#10b981', // Green
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0
                },
                {
                    label: 'LISA',
                    data: data.lisa,
                    borderColor: '#f59e0b', // Amber
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0
                },
                {
                    label: 'Cash',
                    data: data.cash,
                    borderColor: '#64748b', // Slate
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0
                },
                {
                    label: 'Equity',
                    data: data.home_equity,
                    borderColor: '#8b5cf6', // Purple
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 0
                }
            ]
        };

        if (chart) {
            chart.data = chartData;
            chart.update();
        } else {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: '#94a3b8' } },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumSignificantDigits: 3 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155', tickColor: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            grid: { color: '#334155', tickColor: '#334155' },
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    if(value >= 1000000) return '£' + (value/1000000).toFixed(1) + 'm';
                                    if(value >= 1000) return '£' + (value/1000).toFixed(0) + 'k';
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    function updateKPIs(data) {
        const last = data.ages.length - 1;
        
        const fmt = (v) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(v);

        document.getElementById('kpi-networth').innerText = fmt(data.net_worth[last]);
        document.getElementById('kpi-pension').innerText = fmt(data.pension[last]);
        document.getElementById('kpi-liquid').innerText = fmt(data.isa[last] + data.cash[last] + data.lisa[last]);
        document.getElementById('kpi-equity').innerText = fmt(data.home_equity[last]);
        document.getElementById('kpi-age').innerText = `At Age ${data.ages[last]}`;
    }

    // Init
    initUI();
    updateChart();

</script>
</body>
</html>
